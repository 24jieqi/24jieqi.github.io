{"componentChunkName":"component---src-templates-blog-post-js","path":"/backEnd/event-driver/事件驱动基本介绍/","result":{"data":{"site":{"siteMetadata":{"title":"HJGP技术知识库"}},"markdownRemark":{"id":"b7b643c0-597d-5645-bbf6-b72719678871","excerpt":"事件驱动 背景 我们的服务从最开始的手动回滚到分布式事务的引入，始终存在着一个强耦合的问题。随着 DDD…","html":"<h1>事件驱动</h1>\n<h2>背景</h2>\n<p>我们的服务从最开始的手动回滚到分布式事务的引入，始终存在着一个强耦合的问题。随着 DDD 领域驱动设计概念的引入，事件驱动这种模式也进入了我们的视线。</p>\n<p>对于后端来说，事件驱动这种模式可能比较少遇到。但是对于客户端来说，每个按钮的点击，每个文字的变化都伴随着事件的变化。可以说，事件驱动广泛的应用到了整个前端以及客户端的生态圈。那么对于后端，我们为什么要使用事件驱动呢。</p>\n<p>最主要的原因是解耦合！另外，在业务变得日益复杂时，传统的链式调用为了保证事务的一致性，可能会造成很多的长事务。事件驱动结合 saga 可以很好的解决长事务的问题。</p>\n<h2>技术架构</h2>\n<p>目前，我们的事件驱动设计核心是事件表。通过事件表和数据库的事务保证一致性。然后通过CDC订阅处理分发事件。</p>\n<p>​                 (插入事件表)                           (CDC 订阅)</p>\n<p>bussiness         ->             event_table        ->         各个消息队列</p>\n<h3>注意点</h3>\n<p>注意不要产生有向有环图，如果出现事件循环，那么整个事件将永远不会停止。</p>\n<h2>如何使用</h2>\n<ol>\n<li>\n<p>在业务库里建立如下表</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span>\n<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"id\"</span>            int8         <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"topic_name\"</span>    <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"domain_name\"</span>   <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"event_name\"</span>    <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"tenant\"</span>        <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"namespace\"</span>     <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"event_payload\"</span> bytea        <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"create_time\"</span>   timestamptz<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"send_success\"</span>  int2         <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">CONSTRAINT</span> <span class=\"token string\">\"domain_event_message_pkey\"</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">TABLE</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'领域事件消息表'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'主键'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"topic_name\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'分发Topic(全类名)'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_name\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'领域名'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"namespace\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'租户'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"tenant\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'命名空间'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"event_name\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'领域事件名'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"event_payload\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'事件数据'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"create_time\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'创建时间'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">COMMENT</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">COLUMN</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"domain_event_message\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"send_success\"</span> <span class=\"token operator\">IS</span> <span class=\"token string\">'消息发送状态（1：未处理，2：已发送，3：发送异常）'</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>引入如下事件驱动包 repository</p>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>fc.common<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>common-event-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ol start=\"3\">\n<li>使用如下代码引入</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">EventComponent</span> eventComponent<span class=\"token punctuation\">;</span></code></pre></div>\n<p>EventComponent 里面有很多发布事件的方法，我们先来看看他的入参</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">/**\n     * topic 名称\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> topicName<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * 领域名称\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> domainName<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * 事件名称\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> eventName<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * 具体消息\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> eventPayload<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * 命名空间\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> namespace<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * 租户名称\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> tenant<span class=\"token punctuation\">;</span></code></pre></div>\n<p>对于这些入参，事件名称以及具体消息是必填的，其他的如命名空间和租户名称，都会取默认 Pulsar 配置的命名空间已经组合。对于跨领域的事件，请务必指定。</p>\n<ol start=\"4\">\n<li>事件名称的命名规范</li>\n</ol>\n<p>建议以所在团队名称 如 huanglong，pitaya等为前缀 {team_name}-{domain_name}-{action}-EVENT</p>\n<h2>如何订阅事件</h2>\n<p>订阅事件和正常的订阅 pulsar 一致即可</p>\n<h2>FAQ</h2>\n<p>A. 对于事件名称如何保证不重复</p>\n<p>Q.目前我们的打算是各个项目团队不维护事件名称，当需要建立一个新的事件时，统一由江强维护在基础包里。这样做有俩个好处，其一是统一管理，其二是在后续需要做 事件溯源时，可以较为简单的实现整个方案。</p>\n<p>A. 发布的事件没有被消费</p>\n<p>Q.这个多发于测试环境以及预发布环境，大概率是因为磁盘空间不足导致的。这个在上次已经升级过配置，如果再遇到，请及时沟通解决。</p>","frontmatter":{"title":"事件驱动使用指南","date":"Invalid date","description":null,"author":"江强"}},"previous":{"fields":{"slug":"/frontEnd/demo/五子棋/"},"frontmatter":{"title":"使用 React 实现五子棋游戏（选修）"}},"next":{"fields":{"slug":"/frontEnd/其他/调试分享/"},"frontmatter":{"title":"前端调试"}}},"pageContext":{"id":"b7b643c0-597d-5645-bbf6-b72719678871","previousPostId":"e6a3376c-9cf0-56a8-b174-00dfab67385a","nextPostId":"bb5a4749-6a7d-5341-8b0f-82daa0be83de"}},"staticQueryHashes":["2841359383","3257411868"]}